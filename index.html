const carregarEMontarContrato = async () => {
    setLoading(true);
    try {
        // Carregar templates
        const response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&order=ordem.asc`, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY
            }
        });
        const templates = await response.json();

        // Montar o contrato completo
        let contratoCompleto = templates.map(t => t.texto).join('\n\n');

        // ===== PREPARAR TODOS OS DADOS =====
        const nomeCliente = proposta.nome && proposta.sobrenome 
            ? `${proposta.nome} ${proposta.sobrenome}`
            : proposta.nome_fantasia || 'Sem nome';
        
        const cpfCnpj = proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj;
        
        const enderecoCompleto = `${proposta.logradouro || ''}, ${proposta.numero_endereco || ''} ${proposta.complemento ? '- ' + proposta.complemento : ''}, ${proposta.bairro || ''}, ${proposta.cidade || ''} - ${proposta.estado || ''}`.trim();
        
        // Data formatada em português
        const dataAtual = new Date().toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit', 
            year: 'numeric'
        });
        
        // ===== SUBSTITUIR TODOS OS PLACEHOLDERS =====
        contratoCompleto = contratoCompleto
            // Dados do Cliente
            .replace(/\[Nome do Cliente\]/g, nomeCliente)
            .replace(/\[CPF\/CNPJ\]/g, cpfCnpj || 'N/A')
            .replace(/\[Email\]/g, proposta.email || 'N/A')
            .replace(/\[Telefone\]/g, proposta.telefone || 'N/A')
            
            // Endereço Completo
            .replace(/\[Endereço Completo\]/g, enderecoCompleto)
            .replace(/\[Logradouro\]/g, proposta.logradouro || 'N/A')
            .replace(/\[Número\]/g, proposta.numero_endereco || 'N/A')
            .replace(/\[Complemento\]/g, proposta.complemento || '')
            .replace(/\[Bairro\]/g, proposta.bairro || 'N/A')
            .replace(/\[Cidade\]/g, proposta.cidade || 'N/A')
            .replace(/\[Estado\]/g, proposta.estado || 'N/A')
            .replace(/\[CEP\]/g, proposta.cep || 'N/A')
            
            // Dados da Instalação
            .replace(/\[Número da Instalação\]/g, proposta.numero_instalacao || 'N/A')
            .replace(/\[Distribuidora\]/g, proposta.distribuidora_energia || 'N/A')
            .replace(/\[Consumo\]/g, proposta.consumo_kwh || '0')
            .replace(/\[Tipo de Conexão\]/g, proposta.tipo_conexao || 'N/A')
            
            // Dados do Contrato
            .replace(/\[Número do Contrato\]/g, proposta.numero_contrato || 'N/A')
            .replace(/\[Data\]/g, dataAtual)
            .replace(/\[X\]/g, proposta.desconto_aplicado || '15')
            
            // Dados Financeiros
            .replace(/\[Custo Atual\]/g, proposta.simulacao_conta_atual ? `R$ ${parseFloat(proposta.simulacao_conta_atual).toFixed(2)}` : 'N/A')
            .replace(/\[Custo OBY\]/g, proposta.simulacao_conta_nova ? `R$ ${parseFloat(proposta.simulacao_conta_nova).toFixed(2)}` : 'N/A')
            .replace(/\[Economia Mensal\]/g, proposta.simulacao_economia_mensal ? `R$ ${parseFloat(proposta.simulacao_economia_mensal).toFixed(2)}` : 'N/A');

        setContratoTexto(contratoCompleto);
    } catch (error) {
        console.error('Erro ao carregar contrato:', error);
        setContratoTexto('Erro ao carregar o contrato. Por favor, tente novamente.');
    } finally {
        setLoading(false);
    }
};