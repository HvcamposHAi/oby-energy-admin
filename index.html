<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBY Energy - Painel Administrativo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script> 
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configurações do Supabase (MANTIDAS)
        const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

        // Credenciais de Admin (MANTIDAS)
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'oby2025';

        // --- COMPONENTE: RELATÓRIO FINANCEIRO (MANTIDO) ---
        function FinancialReport({ propostas }) {
            
            const propostasAprovadas = propostas.filter(p => p.status === 'aprovado' && p.simulacao_economia_mensal > 0);

            const formatarMoeda = (valor) => {
                const num = parseFloat(valor); 
                if (isNaN(num)) return 'R$ 0,00';
                return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };

            const exportarParaCSV = () => {
                const cabecalho = [
                    "Nº Contrato", "Vendedor", "Cliente", "Email", "Cidade", 
                    "Consumo (kWh)", "Custo Atual (R$)", "Custo OBY (R$)", 
                    "Desconto Aplicado (%)", "Economia Mensal (R$)", "Status"
                ];

                const linhas = propostasAprovadas.map(p => {
                    return [
                        `"${p.numero_contrato || 'N/A'}"`,
                        `"${p.vendedor || 'Sem Vendedor'}"`,
                        `"${p.nome_completo || p.nome_fantasia || 'Sem nome'}"`,
                        `"${p.email || ''}"`,
                        `"${p.cidade || ''}"`,
                        `"${p.consumo_kw || 0}"`,
                        `"${formatarMoeda(p.simulacao_conta_atual).replace('R$', '').trim()}"`,
                        `"${formatarMoeda(p.simulacao_conta_nova).replace('R$', '').trim()}"`,
                        `"${p.desconto_aplicado || 0}"`,
                        `"${formatarMoeda(p.simulacao_economia_mensal).replace('R$', '').trim()}"`,
                        `"${p.status}"`
                    ].join(';');
                });

                const csvContent = [cabecalho.join(';'), ...linhas].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", `relatorio_oby_financeiro_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("Exportação iniciada! Verifique seus downloads.");
            };

            const totalEconomiaMensal = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_economia_mensal) || 0), 0);
            const totalCustoAtual = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_atual) || 0), 0);
            const totalCustoNovo = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_nova) || 0), 0);

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">📊 Relatório Financeiro de Propostas Aprovadas</h2>
                        <button 
                            onClick={exportarParaCSV} 
                            className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:opacity-50"
                            disabled={propostasAprovadas.length === 0}
                        >
                            ⬇️ Exportar para CSV
                        </button>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Propostas Válidas</p>
                            <p className="text-2xl font-bold text-blue-800">{propostasAprovadas.length}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Total Economia Mensal</p>
                            <p className="text-xl font-bold text-green-800">{formatarMoeda(totalEconomiaMensal)}</p>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Soma Custo Atual</p>
                            <p className="text-xl font-bold text-yellow-800">{formatarMoeda(totalCustoAtual)}</p>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Soma Custo OBY</p>
                            <p className="text-xl font-bold text-red-800">{formatarMoeda(totalCustoNovo)}</p>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nº Contrato</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cidade</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">CPF</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {propostasFiltradas.length === 0 ? (
                                    <tr>
                                        <td colSpan="9" className="px-4 py-8 text-center text-gray-500">
                                            {loading ? 'Carregando...' : 'Nenhuma proposta encontrada'}
                                        </td>
                                    </tr>
                                ) : (
                                    propostasFiltradas.map((proposta) => (
                                        <tr key={proposta.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                {proposta.nome_completo || proposta.nome_fantasia || 'Sem nome'}
                                            </td>
                                            <td className="px-4 py-3 text-sm font-semibold text-blue-600">
                                                {proposta.numero_contrato || '-'}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.email}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.cidade}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.telefone}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{formatarData(proposta.created_at)}</td>
                                            <td className="px-4 py-3">
                                                {/* Simplificado: Apenas o Badge do Status (Botão de status movido para o Modal) */}
                                                {getStatusBadge(proposta.status || 'pendente')}
                                            </td>
                                            <td className="px-4 py-3 flex gap-2">
                                                <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                    📝 Editar
                                                </button>
                                                <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                    📄 PDF
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                                            </td>
                                            <td className="px-4 py-3 flex gap-2">
                                                <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                    📝 Editar
                                                </button>
                                                <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                    📄 PDF
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                    </>) : (
                                        <FinancialReport propostas={propostas} />
                                    )
                                }
                            </div>
                            </>
                        )}
                    </div>
                    {selectedProposta && (
                        <EditPropostaModal 
                            proposta={selectedProposta} 
                            onClose={() => setSelectedProposta(null)} 
                            onSave={handleSaveEdit}
                            saving={savingProposta}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<AdminPanel />, document.getElementById('root'));
    </script>
</body>
</html>
