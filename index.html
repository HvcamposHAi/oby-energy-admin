<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OBY Energy â€“ Painel Admin</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">

<div id="root"></div>

<script type="text/babel">

// =================== CONFIG ===================
const SUPABASE_URL = "https://seuprojeto.supabase.co";
const SUPABASE_KEY = "chave-publica-do-supabase";

// =================== GERADOR DE CONTRATO (DOCX) ===================
const gerarContratoDOCX = async (proposta) => {
  try {
    if (!window.docx) {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://unpkg.com/docx@8.5.0/build/index.umd.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Falha ao carregar docx"));
        document.head.appendChild(s);
      });
    }
    const { Document, Packer, Paragraph, HeadingLevel, TextRun } = window.docx;

    // Carrega templates do Supabase
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&order=ordem.asc`, {
      headers: {
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "apikey": SUPABASE_KEY
      }
    });
    if (!resp.ok) throw new Error("Falha ao buscar templates");
    const templates = await resp.json();

    // Placeholders
    const nomeCompleto = (proposta.nome && proposta.sobrenome)
      ? `${proposta.nome} ${proposta.sobrenome}`
      : (proposta.nome_fantasia || "Sem nome");

    const map = {
      numero_contrato: proposta.numero_contrato || "N/A",
      contratante_nome: nomeCompleto,
      contratante_cpf_cnpj: proposta.tipo_pessoa === "fisica" ? (proposta.cpf || "") : (proposta.cnpj || ""),
      contratante_email: proposta.email || "",
      contratante_telefone: proposta.telefone || "",
      contratante_endereco: `${proposta.logradouro || ""}, ${proposta.numero_endereco || ""} ${proposta.complemento ? " - " + proposta.complemento : ""}`,
      contratante_cidade_uf: `${proposta.cidade || ""}${proposta.estado ? " - " + proposta.estado : ""}`,
      contratante_cep: proposta.cep || "",
      distribuidora: proposta.distribuidora_energia || "",
      consumo_kwh: String(proposta.consumo_kwh || 0),
      vendedor: proposta.vendedor || "",
      data_contrato: new Date().toLocaleDateString("pt-BR"),
      contratada_nome: "OBY ENERGY"
    };

    const merge = texto => texto.replace(/\{\{\s*([\w_]+)\s*\}\}/g, (_, k) => map[k] ?? "");

    const secoes = templates.map(t => merge(t.texto || "")).join("\n\n");
    const linhas = secoes.split(/\r?\n/);

    const doc = new Document({
      sections: [{
        children: [
          new Paragraph({ text: `Contrato NÂº: ${map.numero_contrato}`, heading: HeadingLevel.HEADING_3 }),
          new Paragraph({ text: "CONTRATO DE PRESTAÃ‡ÃƒO DE SERVIÃ‡OS", heading: HeadingLevel.HEADING_1 }),
          ...linhas.map(l => new Paragraph({ children: [new TextRun({ text: l })] }))
        ]
      }]
    });

    const blob = await Packer.toBlob(doc);
    const nomeArquivo = `contrato_${nomeCompleto.replace(/\s+/g, "_")}.docx`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("Erro ao gerar contrato: " + e.message);
  }
};

// =================== COMPONENTES ===================
const FinancialReport = () => (
  <div className="p-6">
    <h2 className="text-xl font-semibold mb-2">RelatÃ³rios Financeiros</h2>
    <p>ConteÃºdo dos relatÃ³rios...</p>
  </div>
);

const VendedoresGestao = () => {
  const [vendedores, setVendedores] = React.useState([]);

  const carregarVendedores = async () => {
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/vendedores?select=*`, {
      headers: {
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "apikey": SUPABASE_KEY
      }
    });
    if (resp.ok) {
      const data = await resp.json();
      setVendedores(data);
    }
  };

  React.useEffect(() => { carregarVendedores(); }, []);

  return (
    <div className="p-6">
      <h2 className="text-xl font-semibold mb-4">GestÃ£o de Vendedores</h2>
      <table className="w-full border border-gray-200 text-sm">
        <thead className="bg-gray-100">
          <tr>
            <th className="p-2 border">Nome</th>
            <th className="p-2 border">Email</th>
            <th className="p-2 border">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          {vendedores.map(v => (
            <tr key={v.id}>
              <td className="border p-2">{v.nome}</td>
              <td className="border p-2">{v.email}</td>
              <td className="border p-2 text-center">
                <button onClick={() => gerarContratoDOCX(v)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                  ðŸ“„ DOCX
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

const AdminPanel = () => {
  const [aba, setAba] = React.useState("vendedores");

  return (
    <div>
      <div className="bg-white shadow flex justify-between p-4">
        <h1 className="font-bold text-lg">Painel Admin â€“ OBY Energy</h1>
        <div>
          <button onClick={() => setAba("vendedores")} className={`px-4 py-2 ${aba === "vendedores" ? "bg-green-700 text-white" : "bg-gray-100"} rounded`}>
            Vendedores
          </button>
          <button onClick={() => setAba("financeiro")} className={`px-4 py-2 ml-2 ${aba === "financeiro" ? "bg-green-700 text-white" : "bg-gray-100"} rounded`}>
            Financeiro
          </button>
        </div>
      </div>

      <div>
        {aba === "vendedores" && <VendedoresGestao />}
        {aba === "financeiro" && <FinancialReport />}
      </div>
    </div>
  );
};

const App = () => {
  const [autenticado, setAutenticado] = React.useState(false);

  React.useEffect(() => {
    const admin = localStorage.getItem("oby_admin_autenticado");
    if (admin === "true") setAutenticado(true);
  }, []);

  if (!autenticado) {
    return (
      <div className="flex items-center justify-center h-screen">
        <button
          className="px-4 py-2 bg-green-700 text-white rounded"
          onClick={() => {
            localStorage.setItem("oby_admin_autenticado", "true");
            window.location.reload();
          }}
        >
          Entrar como Admin
        </button>
      </div>
    );
  }

  return <AdminPanel />;
};

// =================== RENDER ===================
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
