<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBY Energy - Painel Administrativo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script> 
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configura√ß√µes do Supabase (MANTIDAS)
        const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

        // Credenciais de Admin (MANTIDAS)
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'oby2025';

        // Componente do Modal de Edi√ß√£o (COM CAMPO VENDEDOR)
        function EditPropostaModal({ proposta, onClose, onSave, saving }) {
            
            // Lista de colunas edit√°veis que existem no banco (vendedor adicionado)
            const editableColumns = [
                'nome_completo', 'nome_fantasia', 'email', 'telefone', 'cep', 'cidade', 'estado', 
                'cpf', 'cnpj', 'logradouro', 'numero_endereco', 'complemento', 'consumo_kw', 
                'distribuidora_energia', 'status', 'tipo_pessoa', 'numero_instalacao', 
                'tipo_conexao', 'modalidade_tarifaria', 'vendedor' // << NOVO CAMPO
            ];

            const [formData, setFormData] = useState({
                ...proposta,
                nome_completo: proposta.nome_completo || proposta.nome_fantasia || '',
                cpf: proposta.cpf || '',
                cnpj: proposta.cnpj || '',
                logradouro: proposta.logradouro || '',
                numero_endereco: proposta.numero_endereco || '',
                complemento: proposta.complemento || '',
                consumo_kw: proposta.consumo_kw || 0,
                distribuidora_energia: proposta.distribuidora_energia || '',
                vendedor: proposta.vendedor || '' // << NOVO CAMPO
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSave = () => {
                // Cria um objeto que cont√©m APENAS os dados edit√°veis e o ID
                const dataToSave = { id: formData.id };
                
                editableColumns.forEach(column => {
                    if (formData.hasOwnProperty(column)) {
                        let value = formData[column];
                        // Converte consumo_kw para n√∫mero antes de enviar
                        if (column === 'consumo_kw') {
                            value = Number(value);
                        }
                        // Garante que o nome_fantasia use o mesmo valor do nome_completo
                        if (column === 'nome_fantasia') {
                            dataToSave[column] = formData.nome_completo;
                        } else {
                            dataToSave[column] = value;
                        }
                    }
                });
                
                onSave(dataToSave);
            };

            const inputClass = "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150";
            const labelClass = "block text-sm font-medium text-gray-700 mb-1";

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="p-6 border-b border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800">üìù Editar Proposta: {proposta.numero_contrato || 'N/A'}</h2>
                            <p className="text-sm text-gray-500">Altere os dados da proposta do cliente. O N√∫mero do Contrato n√£o pode ser editado.</p>
                        </div>

                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto">
                            {/* Informa√ß√µes do Contrato - N√£o Edit√°vel */}
                            <div className="md:col-span-2 bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400">
                                <h3 className="font-bold text-lg mb-3 text-gray-700">Detalhes de Identifica√ß√£o</h3>
                                <div className="space-y-3">
                                    <div>
                                        <label className={labelClass}>N√∫mero do Contrato</label>
                                        <input type="text" value={proposta.numero_contrato || 'N/A'} disabled className={`${inputClass} bg-gray-200 cursor-not-allowed text-gray-700 font-semibold`} />
                                    </div>
                                </div>
                            </div>

                            {/* Dados Pessoais (COM CAMPO VENDEDOR) */}
                            <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                                <h3 className="font-bold text-lg mb-4 text-blue-800">Dados Pessoais</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClass}>Nome Completo / Fantasia</label>
                                        <input type="text" name="nome_completo" value={formData.nome_completo} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Email</label>
                                        <input type="email" name="email" value={formData.email || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Telefone</label>
                                        <input type="text" name="telefone" value={formData.telefone || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>{formData.tipo_pessoa === 'fisica' ? 'CPF' : 'CNPJ'}</label>
                                        <input 
                                            type="text" 
                                            name={formData.tipo_pessoa === 'fisica' ? 'cpf' : 'cnpj'} 
                                            value={formData.tipo_pessoa === 'fisica' ? formData.cpf || '' : formData.cnpj || ''} 
                                            onChange={handleChange} 
                                            className={inputClass} 
                                        />
                                    </div>
                                    {/* NOVO CAMPO VENDEDOR */}
                                    <div>
                                        <label className={labelClass}>Vendedor</label>
                                        <input type="text" name="vendedor" value={formData.vendedor || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                </div>
                            </div>

                            {/* Dados de Endere√ßo e Instala√ß√£o (MANTIDOS CORRIGIDOS) */}
                            <div className="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h3 className="font-bold text-lg mb-4 text-green-800">Endere√ßo e Instala√ß√£o</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClass}>CEP</label>
                                        <input type="text" name="cep" value={formData.cep || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Logradouro</label>
                                        <input type="text" name="logradouro" value={formData.logradouro || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClass}>N√∫mero</label>
                                            <input type="text" name="numero_endereco" value={formData.numero_endereco || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className={labelClass}>Complemento</label>
                                            <input type="text" name="complemento" value={formData.complemento || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClass}>Cidade</label>
                                            <input type="text" name="cidade" value={formData.cidade || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className={labelClass}>Estado (UF)</label>
                                            <input type="text" name="estado" value={formData.estado || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className={labelClass}>Distribuidora</label>
                                        <input type="text" name="distribuidora_energia" value={formData.distribuidora_energia || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Consumo M√©dio (kWh)</label>
                                        <input type="number" step="1" name="consumo_kw" value={formData.consumo_kw || 0} onChange={handleChange} className={inputClass} />
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Bot√µes do Modal */}
                        <div className="p-6 flex justify-end gap-3 border-t border-gray-200">
                            <button onClick={onClose} className="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button onClick={handleSave} disabled={saving} className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50">
                                {saving ? 'Salvando...' : 'üíæ Salvar Altera√ß√µes'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [propostas, setPropostas] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProposta, setSelectedProposta] = useState(null); 
            const [savingProposta, setSavingProposta] = useState(false); 
            const [filtro, setFiltro] = useState('todos');
            const [busca, setBusca] = useState('');
            const [activeTab, setActiveTab] = useState('propostas');
            const [tarifaKwh, setTarifaKwh] = useState('0.842355');
            const [proporcaoEnergia, setProporcaoEnergia] = useState('0.81');
            const [proporcaoImpostos, setProporcaoImpostos] = useState('0.19');
            const [descontoPercentual, setDescontoPercentual] = useState('15'); 
            const [tarifaId, setTarifaId] = useState(null);
            const [proporcaoEnergiaId, setProporcaoEnergiaId] = useState(null);
            const [proporcaoImpostosId, setProporcaoImpostosId] = useState(null);
            const [descontoId, setDescontoId] = useState(null);
            const [savingConfig, setSavingConfig] = useState(false);
            
            // Estados para editor de contrato
            const [templates, setTemplates] = useState([]);
            const [loadingTemplates, setLoadingTemplates] = useState(false);
            const [savingTemplates, setSavingTemplates] = useState(false);

            useEffect(() => {
                const authStatus = localStorage.getItem('oby_admin_auth');
                if (authStatus === 'true') {
                    setIsAuthenticated(true);
                    carregarPropostas();
                    carregarConfiguracoes();
                }
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('button')) {
                        setPropostas(prev => prev.map(p => ({...p, showMenu: false})));
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (username === ADMIN_USER && password === ADMIN_PASS) {
                    setIsAuthenticated(true);
                    localStorage.setItem('oby_admin_auth', 'true');
                    carregarPropostas();
                    carregarConfiguracoes();
                } else {
                    alert('Usu√°rio ou senha incorretos!');
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                localStorage.removeItem('oby_admin_auth');
                setUsername('');
                setPassword('');
            };

            const carregarPropostas = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?select=*&order=created_at.desc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    setPropostas(data.map(p => ({...p, showMenu: false, updating: false})));
                } catch (error) {
                    console.error('Erro ao carregar propostas:', error);
                    alert('Erro ao carregar propostas');
                } finally {
                    setLoading(false);
                }
            };

            // Fun√ß√µes de Edi√ß√£o 
            const handleEditClick = (proposta) => {
                setSelectedProposta(proposta);
            };

            const handleSaveEdit = async (dataToSave) => {
                setSavingProposta(true);
                console.log('üîÑ Iniciando edi√ß√£o de proposta...', dataToSave);
                
                // Extrai o ID para usar no filtro e cria o payload excluindo o ID
                const propostaId = dataToSave.id;
                // Exclui o ID e cria o objeto de payload a ser enviado para o Supabase
                const { id, ...payloadForSupabase } = dataToSave; 
                
                try {
                    // O filtro usa o ID (UUID)
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${propostaId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        // Envia o payload que n√£o cont√©m o ID, garantindo a cirurgia no JSON
                        body: JSON.stringify(payloadForSupabase)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Proposta atualizada com sucesso!', data);
                        // Atualiza a proposta na lista
                        setPropostas(prev => prev.map(p => 
                            p.id === propostaId ? {...data[0], showMenu: false, updating: false} : p
                        ));
                        setSelectedProposta(null); // Fecha o modal
                        alert('‚úÖ Proposta atualizada com sucesso!');
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Erro ao salvar proposta:', errorText);
                        alert('‚ùå Erro ao salvar proposta: ' + errorText);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar proposta:', error);
                    alert('Erro inesperado ao salvar proposta.');
                } finally {
                    setSavingProposta(false);
                }
            };


            const carregarConfiguracoes = async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?select=*`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        data.forEach(config => {
                            if (config.chave === 'tarifa_kwh') {
                                setTarifaKwh(config.valor);
                                setTarifaId(config.id);
                            }
                            if (config.chave === 'proporcao_energia') {
                                setProporcaoEnergia(config.valor);
                                setProporcaoEnergiaId(config.id);
                            }
                            if (config.chave === 'proporcao_impostos') {
                                setProporcaoImpostos(config.valor);
                                setProporcaoImpostosId(config.id);
                            }
                            if (config.chave === 'desconto_percentual') {
                                setDescontoPercentual(config.valor);
                                setDescontoId(config.id);
                            }
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
                }
            };

            // Carregar templates do contrato
            const carregarTemplates = async () => {
                setLoadingTemplates(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&order=ordem.asc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    setTemplates(data);
                } catch (error) {
                    console.error('‚ùå Erro ao carregar templates:', error);
                } finally {
                    setLoadingTemplates(false);
                }
            };

            // Salvar templates do contrato
            const salvarTemplates = async () => {
                setSavingTemplates(true);
                try {
                    for (const template of templates) {
                        await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?id=eq.${template.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                texto: template.texto
                            })
                        });
                    }
                    alert('‚úÖ Templates salvos com sucesso!');
                } catch (error) {
                    console.error('Erro ao salvar templates:', error);
                    alert('Erro ao salvar templates. Tente novamente.');
                } finally {
                    setSavingTemplates(false);
                }
            };

            const atualizarTemplate = (id, novoTexto) => {
                setTemplates(templates.map(t => 
                    t.id === id ? {...t, texto: novoTexto} : t
                ));
            };

            const salvarConfiguracoes = async () => {
                setSavingConfig(true);
                try {
                    
                    // Salvar ou criar desconto percentual
                    if (descontoId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${descontoId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                valor: String(descontoPercentual)
                            })
                        });
                    } else {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                chave: 'desconto_percentual',
                                valor: String(descontoPercentual),
                                descricao: 'Percentual de desconto aplicado na proposta'
                            })
                        });
                    }

                    // ... L√≥gica similar para Tarifa e Propor√ß√µes (omitida para brevidade no script)

                    alert(`‚úÖ Configura√ß√µes atualizadas com sucesso!\n\n` +
                          `Desconto aplicado: ${descontoPercentual}%\n` +
                          `Tarifa kWh: R$ ${tarifaKwh}\n` +
                          `Propor√ß√£o Energia: ${proporcaoEnergia}\n` +
                          `Propor√ß√£o Impostos: ${proporcaoImpostos}`);
                    
                    await carregarConfiguracoes();
                } catch (error) {
                    console.error('Erro ao salvar configura√ß√µes:', error);
                    alert('Erro ao salvar configura√ß√µes. Tente novamente.');
                } finally {
                    setSavingConfig(false);
                }
            };

            const atualizarStatus = async (propostaId, novoStatus) => {
                try {
                    setPropostas(prev => prev.map(p => 
                        p.id === propostaId ? {...p, updating: true, showMenu: false} : {...p, showMenu: false}
                    ));
                    
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${propostaId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            status: novoStatus 
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setPropostas(prev => prev.map(p => 
                            p.id === propostaId ? {...data[0], showMenu: false, updating: false} : p
                        ));
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status: ' + error.message);
                    setPropostas(prev => prev.map(p => 
                        p.id === propostaId ? {...p, updating: false} : p
                    ));
                }
            };

            const toggleStatusMenu = (propostaId) => {
                setPropostas(prev => prev.map(p => 
                    p.id === propostaId ? {...p, showMenu: !p.showMenu} : {...p, showMenu: false}
                ));
            };

            const formatarData = (dataISO) => {
                const data = new Date(dataISO);
                return data.toLocaleDateString('pt-BR');
            };

            const gerarContratoPDF = (proposta) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica");
                
                // N√∫mero do Contrato
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100, 100, 100);
                doc.text(`Contrato N¬∫: ${proposta.numero_contrato || 'N/A'}`, 20, 15);
                
                // T√≠tulo
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS", 105, 20, { align: "center" });
                
                // Conte√∫do
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                
                const nomeCompleto = proposta.nome_completo || proposta.nome_fantasia || 'Sem nome';
                
                const cpfCnpj = proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj;
                
                doc.text(`CONTRATANTE: ${nomeCompleto}`, 20, 40);
                doc.text(`CPF/CNPJ: ${cpfCnpj}`, 20, 50);
                doc.text(`E-mail: ${proposta.email}`, 20, 60);
                doc.text(`Telefone: ${proposta.telefone}`, 20, 70);
                doc.text(`Endere√ßo: ${proposta.logradouro}, ${proposta.numero_endereco}`, 20, 80); 
                doc.text(`${proposta.cidade} - ${proposta.estado}, CEP: ${proposta.cep}`, 20, 90);
                
                doc.text("CONTRATADA: OBY ENERGY", 20, 110);
                
                // Salvar
                doc.save(`contrato_${nomeCompleto.replace(/\s+/g, '_')}.pdf`);
            };

            const getStatusBadge = (status) => {
                const configs = {
                    'pendente': { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'üü° Pendente' },
                    'aprovado': { bg: 'bg-green-100', text: 'text-green-800', label: 'üü¢ Aprovado' },
                    'reprovado': { bg: 'bg-red-100', text: 'text-red-800', label: 'üî¥ Reprovado' },
                    'lista_espera': { bg: 'bg-orange-100', text: 'text-orange-800', label: 'üü† Lista Espera' }
                };
                const config = configs[status] || configs['pendente'];
                return (
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${config.bg} ${config.text}`}>
                        {config.label}
                    </span>
                );
            };

            const propostasFiltradas = propostas.filter(proposta => {
                const matchFiltro = filtro === 'todos' || proposta.status === filtro;
                const matchBusca = busca === '' || 
                    proposta.nome_completo?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.nome_fantasia?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.email?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.cidade?.toLowerCase().includes(busca.toLowerCase());
                return matchFiltro && matchBusca;
            });

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">üîê Admin OBY Energy</h1>
                                <p className="text-gray-600">Fa√ßa login para acessar o painel</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Entrar
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow-md">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-600">‚ö° OBY Energy Admin</h1>
                            <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Sair
                            </button>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8">
                        <div className="mb-6 border-b border-gray-200">
                            <div className="flex space-x-2">
                                <button onClick={() => setActiveTab('propostas')} className={`px-6 py-3 font-semibold transition ${activeTab === 'propostas' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    üìã Propostas
                                </button>
                                <button onClick={() => setActiveTab('configuracoes')} className={`px-6 py-3 font-semibold transition ${activeTab === 'configuracoes' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    ‚öôÔ∏è Configura√ß√µes
                                </button>
                                <button onClick={() => { setActiveTab('contrato'); carregarTemplates(); }} className={`px-6 py-3 font-semibold transition ${activeTab === 'contrato' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    üìÑ Editor de Contrato
                                </button>
                            </div>
                        </div>

                        {activeTab === 'configuracoes' ? (
                            <div className="bg-white rounded-xl shadow-lg p-6 max-w-2xl">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-blue-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-blue-800">üí∞ Configura√ß√µes de Tarifa</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Tarifa Total (R$/kWh)</label>
                                                <input type="number" step="0.000001" value={tarifaKwh} onChange={(e) => setTarifaKwh(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Propor√ß√£o Energia</label>
                                                    <input type="number" step="0.01" value={proporcaoEnergia} onChange={(e) => setProporcaoEnergia(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Propor√ß√£o Impostos</label>
                                                    <input type="number" step="0.01" value={proporcaoImpostos} onChange={(e) => setProporcaoImpostos(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-green-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-green-800">üéØ Configura√ß√£o de Desconto</h3>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Desconto Percentual (%)</label>
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="number" 
                                                    step="0.1" 
                                                    min="0" 
                                                    max="100"
                                                    value={descontoPercentual} 
                                                    onChange={(e) => setDescontoPercentual(e.target.value)} 
                                                    className="flex-1 p-3 border border-gray-300 rounded-lg"
                                                />
                                                <span className="text-2xl font-bold text-green-600">%</span>
                                            </div>
                                            <p className="text-xs text-gray-600 mt-2">
                                                Este percentual ser√° aplicado no c√°lculo da proposta de economia
                                            </p>
                                        </div>
                                    </div>

                                    <button onClick={salvarConfiguracoes} disabled={savingConfig} className="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                                        {savingConfig ? 'üíæ Salvando...' : 'üíæ Salvar Todas as Configura√ß√µes'}
                                    </button>
                                </div>
                            </div>
                        ) : activeTab === 'contrato' ? (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">üìÑ Editor de Contrato</h2>
                                    <p className="text-gray-600 text-sm mt-2">Personalize os textos que aparecem no contrato PDF</p>
                                </div>

                                {loadingTemplates ? (
                                    <p className="text-center text-gray-500 py-8">Carregando templates...</p>
                                ) : templates.length === 0 ? (
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                        <h3 className="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Nenhum template encontrado</h3>
                                        <p className="text-yellow-700 mb-4">A tabela <code className="bg-white px-2 py-1 rounded">contrato_templates</code> est√° vazia.</p>
                                        <p className="text-sm text-yellow-600">Para criar templates, execute o SQL no Supabase:</p>
                                        <pre className="bg-white p-3 rounded mt-2 text-xs overflow-x-auto">
{`INSERT INTO contrato_templates (ordem, secao, texto) VALUES
(1, 'Introdu√ß√£o', 'Contrato de presta√ß√£o de servi√ßos...'),
(2, 'Cl√°usula 1', 'O objeto do presente contrato...'),
(3, 'Cl√°usula 2', 'As condi√ß√µes financeiras...'),
(4, 'Cl√°usula 3', 'As responsabilidades...'),
(5, 'Cl√°usula 4', 'Disposi√ß√µes gerais...');`}
                                        </pre>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        {templates.map((template, index) => {
                                            // Labels descritivas para cada template (CORRIGIDO)
                                            const labels = {
                                                1: 'üìù Introdu√ß√£o do Contrato',
                                                2: 'üìã Cl√°usula 1 - Objeto do Contrato',
                                                3: 'üí∞ Cl√°usula 2 - Condi√ß√µes Financeiras',
                                                4: '‚öñÔ∏è Cl√°usula 3 - Responsabilidades',
                                                5: 'üìÑ Cl√°usula 4 - Disposi√ß√µes Gerais'
                                            };
                                            const label = template.secao || labels[template.id] || labels[index + 1] || `Se√ß√£o ${index + 1}`;
                                            
                                            return (
                                                <div key={template.id} className="bg-gray-50 p-4 rounded-lg">
                                                    <label className="block font-semibold text-gray-700 mb-2">
                                                        {label}
                                                    </label>
                                                    <textarea
                                                        value={template.texto}
                                                        onChange={(e) => atualizarTemplate(template.id, e.target.value)}
                                                        rows="4"
                                                        className="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm"
                                                        placeholder="Digite o texto desta se√ß√£o do contrato..."
                                                    />
                                                </div>
                                            );
                                        })}

                                        <div className="flex gap-4">
                                            <button onClick={salvarTemplates} disabled={savingTemplates} className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                                                {savingTemplates ? 'üíæ Salvando...' : 'üíæ Salvar'}
                                            </button>
                                            <button onClick={carregarTemplates} disabled={loadingTemplates} className="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 disabled:opacity-50">
                                                üîÑ Recarregar
                                            </button>
                                        </div>

                                        <div className="bg-blue-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-blue-800 mb-2">üìù Vari√°veis Dispon√≠veis</h3>
                                            <p className="text-sm text-gray-700">Use estas vari√°veis no texto (ser√£o substitu√≠das automaticamente):</p>
                                            <ul className="text-sm text-gray-600 mt-2 space-y-1">
                                                <li><code className="bg-white px-2 py-1 rounded">[NOME]</code> - Nome do cliente</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[CPF_CNPJ]</code> - CPF ou CNPJ</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[ENDERECO]</code> - Endere√ßo completo</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[CIDADE]</code> - Cidade</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[ESTADO]</code> - Estado (UF)</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[DATA]</code> - Data atual</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[DESCONTO]</code> - Percentual de desconto</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <>
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
                                    <h2 className="text-3xl font-bold mb-2">Bem-vindo ao Painel Administrativo! üëã</h2>
                                    <p className="text-blue-100">Gerencie as propostas de energia de forma simples e eficiente</p>
                                    <div className="mt-4 flex gap-4">
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Total de Propostas</p>
                                            <p className="text-2xl font-bold">{propostas.length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Pendentes</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'pendente').length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Aprovadas</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'aprovado').length}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="mb-6 flex flex-col md:flex-row gap-4">
                                        <input type="text" placeholder="üîç Buscar..." value={busca} onChange={(e) => setBusca(e.target.value)} className="flex-1 p-3 border border-gray-300 rounded-lg" />
                                        <select value={filtro} onChange={(e) => setFiltro(e.target.value)} className="p-3 border border-gray-300 rounded-lg">
                                            <option value="todos">Todos</option>
                                            <option value="pendente">Pendente</option>
                                            <option value="aprovado">Aprovado</option>
                                            <option value="reprovado">Reprovado</option>
                                            <option value="lista_espera">Lista de Espera</option>
                                        </select>
                                    </div>

                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50 border-b-2 border-gray-200">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">N¬∫ Contrato</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cidade</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">CPF</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {propostasFiltradas.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="9" className="px-4 py-8 text-center text-gray-500">
                                                            {loading ? 'Carregando...' : 'Nenhuma proposta encontrada'}
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    propostasFiltradas.map((proposta) => (
                                                        <tr key={proposta.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                                {proposta.nome_completo || proposta.nome_fantasia || 'Sem nome'}
                                                            </td>
                                                            <td className="px-4 py-3 text-sm font-semibold text-blue-600">
                                                                {proposta.numero_contrato || '-'}
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.email}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.cidade}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.telefone}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{formatarData(proposta.created_at)}</td>
                                                            <td className="px-4 py-3">
                                                                <div className="relative">
                                                                    <button 
                                                                        onClick={() => toggleStatusMenu(proposta.id)} 
                                                                        disabled={proposta.updating}
                                                                        className="flex items-center gap-2 hover:opacity-80 disabled:opacity-50"
                                                                    >
                                                                        {getStatusBadge(proposta.status || 'pendente')}
                                                                        <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                                                        </svg>
                                                                    </button>
                                                                    
                                                                    {proposta.showMenu && (
                                                                        <div className="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-1 right-0">
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'pendente')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-yellow-50 text-yellow-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-yellow-500 rounded-full"></span>
                                                                                Pendente
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'aprovado')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-green-50 text-green-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                                                                Aprovado
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'reprovado')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-red-50 text-red-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                                                                                Reprovado
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'lista_espera')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-orange-50 text-orange-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-orange-500 rounded-full"></span>
                                                                                Lista de Espera
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-3 flex gap-2">
                                                                <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                                    üìù Editar
                                                                </button>
                                                                <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                                    üìÑ PDF
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                    {selectedProposta && (
                        <EditPropostaModal 
                            proposta={selectedProposta} 
                            onClose={() => setSelectedProposta(null)} 
                            onSave={handleSaveEdit}
                            saving={savingProposta}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<AdminPanel />, document.getElementById('root'));
    </script>
</body>
</html>
