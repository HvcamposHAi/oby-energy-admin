<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBY Energy - Painel Administrativo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'oby2025';

        function AdminPanel() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [propostas, setPropostas] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProposta, setSelectedProposta] = useState(null);
            const [filtro, setFiltro] = useState('todos');
            const [busca, setBusca] = useState('');
            const [activeTab, setActiveTab] = useState('propostas');
            const [tarifaKwh, setTarifaKwh] = useState('0.842355');
            const [proporcaoEnergia, setProporcaoEnergia] = useState('0.81');
            const [proporcaoImpostos, setProporcaoImpostos] = useState('0.19');
            const [descontoPercentual, setDescontoPercentual] = useState('15'); // NOVO
            const [tarifaId, setTarifaId] = useState(null);
            const [proporcaoEnergiaId, setProporcaoEnergiaId] = useState(null);
            const [proporcaoImpostosId, setProporcaoImpostosId] = useState(null);
            const [descontoId, setDescontoId] = useState(null); // NOVO
            const [savingConfig, setSavingConfig] = useState(false);
            
            // Estados para editor de contrato
            const [templates, setTemplates] = useState([]);
            const [loadingTemplates, setLoadingTemplates] = useState(false);
            const [savingTemplates, setSavingTemplates] = useState(false);

            useEffect(() => {
                const authStatus = localStorage.getItem('oby_admin_auth');
                if (authStatus === 'true') {
                    setIsAuthenticated(true);
                    carregarPropostas();
                    carregarConfiguracoes();
                }
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('button')) {
                        setPropostas(prev => prev.map(p => ({...p, showMenu: false})));
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (username === ADMIN_USER && password === ADMIN_PASS) {
                    setIsAuthenticated(true);
                    localStorage.setItem('oby_admin_auth', 'true');
                    carregarPropostas();
                    carregarConfiguracoes();
                } else {
                    alert('Usuário ou senha incorretos!');
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                localStorage.removeItem('oby_admin_auth');
                setUsername('');
                setPassword('');
            };

            const carregarPropostas = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?select=*&order=created_at.desc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    setPropostas(data.map(p => ({...p, showMenu: false, updating: false})));
                } catch (error) {
                    console.error('Erro ao carregar propostas:', error);
                    alert('Erro ao carregar propostas');
                } finally {
                    setLoading(false);
                }
            };

            const carregarConfiguracoes = async () => {
                try {
                    console.log('📥 Carregando configurações do banco...');
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?select=*`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    console.log('📥 Configurações recebidas:', data);
                    
                    if (data && data.length > 0) {
                        data.forEach(config => {
                            if (config.chave === 'tarifa_kwh') {
                                setTarifaKwh(config.valor);
                                setTarifaId(config.id);
                                console.log('✅ Tarifa carregada:', config.valor);
                            }
                            if (config.chave === 'proporcao_energia') {
                                setProporcaoEnergia(config.valor);
                                setProporcaoEnergiaId(config.id);
                                console.log('✅ Proporção Energia carregada:', config.valor);
                            }
                            if (config.chave === 'proporcao_impostos') {
                                setProporcaoImpostos(config.valor);
                                setProporcaoImpostosId(config.id);
                                console.log('✅ Proporção Impostos carregada:', config.valor);
                            }
                            // NOVO: Carregar desconto percentual
                            if (config.chave === 'desconto_percentual') {
                                setDescontoPercentual(config.valor);
                                setDescontoId(config.id);
                                console.log('✅ Desconto carregado:', config.valor + '%', 'ID:', config.id);
                            }
                        });
                    }
                } catch (error) {
                    console.error('❌ Erro ao carregar configurações:', error);
                }
            };

            // Carregar templates do contrato
            const carregarTemplates = async () => {
                setLoadingTemplates(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&order=ordem.asc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    setTemplates(data);
                } catch (error) {
                    console.error('Erro ao carregar templates:', error);
                } finally {
                    setLoadingTemplates(false);
                }
            };

            // Salvar templates do contrato
            const salvarTemplates = async () => {
                setSavingTemplates(true);
                try {
                    for (const template of templates) {
                        await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?id=eq.${template.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                texto: template.texto,
                                updated_at: new Date().toISOString()
                            })
                        });
                    }
                    alert('✅ Templates salvos com sucesso!');
                } catch (error) {
                    console.error('Erro ao salvar templates:', error);
                    alert('Erro ao salvar templates. Tente novamente.');
                } finally {
                    setSavingTemplates(false);
                }
            };

            const atualizarTemplate = (id, novoTexto) => {
                setTemplates(templates.map(t => 
                    t.id === id ? {...t, texto: novoTexto} : t
                ));
            };

            const salvarConfiguracoes = async () => {
                setSavingConfig(true);
                try {
                    console.log('🔹 Iniciando salvamento do desconto:', descontoPercentual);
                    
                    // Salvar ou criar desconto percentual
                    if (descontoId) {
                        console.log('🔹 Atualizando desconto existente (ID:', descontoId, ')');
                        // Atualizar registro existente
                        const responseDesconto = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${descontoId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                valor: String(descontoPercentual)
                            })
                        });
                        
                        if (responseDesconto.ok) {
                            const dataDesconto = await responseDesconto.json();
                            console.log('✅ Desconto atualizado com sucesso:', dataDesconto);
                        } else {
                            const errorText = await responseDesconto.text();
                            console.error('❌ Erro ao atualizar desconto:', errorText);
                        }
                    } else {
                        console.log('🔹 Criando novo registro de desconto');
                        // Criar novo registro
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                chave: 'desconto_percentual',
                                valor: String(descontoPercentual),
                                descricao: 'Percentual de desconto aplicado na proposta'
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('✅ Desconto criado com sucesso:', data);
                            if (data && data.length > 0) {
                                setDescontoId(data[0].id);
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('❌ Erro ao criar desconto:', errorText);
                        }
                    }

                    if (tarifaId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${tarifaId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                valor: tarifaKwh
                            })
                        });
                    }

                    if (proporcaoEnergiaId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${proporcaoEnergiaId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                valor: proporcaoEnergia
                            })
                        });
                    }

                    if (proporcaoImpostosId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${proporcaoImpostosId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                valor: proporcaoImpostos
                            })
                        });
                    }

                    alert(`✅ Configurações atualizadas com sucesso!\n\n` +
                          `Desconto aplicado: ${descontoPercentual}%\n` +
                          `Tarifa kWh: R$ ${tarifaKwh}\n` +
                          `Proporção Energia: ${proporcaoEnergia}\n` +
                          `Proporção Impostos: ${proporcaoImpostos}`);
                    
                    // Recarregar configurações para confirmar salvamento
                    await carregarConfiguracoes();
                } catch (error) {
                    console.error('Erro ao salvar configurações:', error);
                    alert('Erro ao salvar configurações. Tente novamente.');
                } finally {
                    setSavingConfig(false);
                }
            };

            const atualizarStatus = async (propostaId, novoStatus) => {
                try {
                    setPropostas(prev => prev.map(p => 
                        p.id === propostaId ? {...p, updating: true, showMenu: false} : {...p, showMenu: false}
                    ));

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${propostaId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            status: novoStatus,
                            updated_at: new Date().toISOString()
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setPropostas(prev => prev.map(p => 
                            p.id === propostaId ? {...data[0], showMenu: false, updating: false} : p
                        ));
                    }
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status. Tente novamente.');
                    setPropostas(prev => prev.map(p => 
                        p.id === propostaId ? {...p, updating: false} : p
                    ));
                }
            };

            const toggleStatusMenu = (propostaId) => {
                setPropostas(prev => prev.map(p => 
                    p.id === propostaId ? {...p, showMenu: !p.showMenu} : {...p, showMenu: false}
                ));
            };

            const formatarData = (dataISO) => {
                const data = new Date(dataISO);
                return data.toLocaleDateString('pt-BR');
            };

            const gerarContratoPDF = (proposta) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica");
                
                // Título
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("CONTRATO DE PRESTAÇÃO DE SERVIÇOS", 105, 20, { align: "center" });
                
                // Conteúdo
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                
                const nomeCompleto = proposta.tipo_pessoa === 'fisica' 
                    ? `${proposta.nome} ${proposta.sobrenome}`
                    : proposta.nome_fantasia;
                
                const cpfCnpj = proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj;
                
                doc.text(`CONTRATANTE: ${nomeCompleto}`, 20, 40);
                doc.text(`CPF/CNPJ: ${cpfCnpj}`, 20, 50);
                doc.text(`E-mail: ${proposta.email}`, 20, 60);
                doc.text(`Telefone: ${proposta.telefone}`, 20, 70);
                doc.text(`Endereço: ${proposta.endereco}, ${proposta.numero}`, 20, 80);
                doc.text(`${proposta.cidade} - ${proposta.estado}, CEP: ${proposta.cep}`, 20, 90);
                
                doc.text("CONTRATADA: OBY ENERGY", 20, 110);
                
                // Salvar
                doc.save(`contrato_${nomeCompleto.replace(/\s+/g, '_')}.pdf`);
            };

            const getStatusBadge = (status) => {
                const configs = {
                    'pendente': { bg: 'bg-yellow-100', text: 'text-yellow-800', label: '🟡 Pendente' },
                    'aprovado': { bg: 'bg-green-100', text: 'text-green-800', label: '🟢 Aprovado' },
                    'reprovado': { bg: 'bg-red-100', text: 'text-red-800', label: '🔴 Reprovado' },
                    'lista_espera': { bg: 'bg-orange-100', text: 'text-orange-800', label: '🟠 Lista Espera' }
                };
                const config = configs[status] || configs['pendente'];
                return (
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${config.bg} ${config.text}`}>
                        {config.label}
                    </span>
                );
            };

            const propostasFiltradas = propostas.filter(proposta => {
                const matchFiltro = filtro === 'todos' || proposta.status === filtro;
                const matchBusca = busca === '' || 
                    proposta.nome?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.sobrenome?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.email?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.cidade?.toLowerCase().includes(busca.toLowerCase());
                return matchFiltro && matchBusca;
            });

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">🔐 Admin OBY Energy</h1>
                                <p className="text-gray-600">Faça login para acessar o painel</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Entrar
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow-md">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-600">⚡ OBY Energy Admin</h1>
                            <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Sair
                            </button>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8">
                        <div className="mb-6 border-b border-gray-200">
                            <div className="flex space-x-2">
                                <button onClick={() => setActiveTab('propostas')} className={`px-6 py-3 font-semibold transition ${activeTab === 'propostas' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    📋 Propostas
                                </button>
                                <button onClick={() => setActiveTab('configuracoes')} className={`px-6 py-3 font-semibold transition ${activeTab === 'configuracoes' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    ⚙️ Configurações
                                </button>
                                <button onClick={() => { setActiveTab('contrato'); carregarTemplates(); }} className={`px-6 py-3 font-semibold transition ${activeTab === 'contrato' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    📄 Editor de Contrato
                                </button>
                            </div>
                        </div>

                        {activeTab === 'configuracoes' ? (
                            <div className="bg-white rounded-xl shadow-lg p-6 max-w-2xl">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">⚙️ Configurações do Sistema</h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-blue-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-blue-800">💰 Configurações de Tarifa</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Tarifa Total (R$/kWh)</label>
                                                <input type="number" step="0.000001" value={tarifaKwh} onChange={(e) => setTarifaKwh(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Proporção Energia</label>
                                                    <input type="number" step="0.01" value={proporcaoEnergia} onChange={(e) => setProporcaoEnergia(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Proporção Impostos</label>
                                                    <input type="number" step="0.01" value={proporcaoImpostos} onChange={(e) => setProporcaoImpostos(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-green-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-green-800">🎯 Configuração de Desconto</h3>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Desconto Percentual (%)</label>
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="number" 
                                                    step="0.1" 
                                                    min="0" 
                                                    max="100"
                                                    value={descontoPercentual} 
                                                    onChange={(e) => setDescontoPercentual(e.target.value)} 
                                                    className="flex-1 p-3 border border-gray-300 rounded-lg"
                                                />
                                                <span className="text-2xl font-bold text-green-600">%</span>
                                            </div>
                                            <p className="text-xs text-gray-600 mt-2">
                                                Este percentual será aplicado no cálculo da proposta de economia
                                            </p>
                                        </div>
                                    </div>

                                    <button onClick={salvarConfiguracoes} disabled={savingConfig} className="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                                        {savingConfig ? '💾 Salvando...' : '💾 Salvar Todas as Configurações'}
                                    </button>
                                </div>
                            </div>
                        ) : activeTab === 'contrato' ? (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">📄 Editor de Contrato</h2>
                                    <p className="text-gray-600 text-sm mt-2">Personalize os textos que aparecem no contrato PDF</p>
                                </div>

                                {loadingTemplates ? (
                                    <p className="text-center text-gray-500 py-8">Carregando templates...</p>
                                ) : (
                                    <div className="space-y-6">
                                        {templates.map((template) => (
                                            <div key={template.id} className="bg-gray-50 p-4 rounded-lg">
                                                <label className="block font-semibold text-gray-700 mb-2">
                                                    {template.secao}
                                                </label>
                                                <textarea
                                                    value={template.texto}
                                                    onChange={(e) => atualizarTemplate(template.id, e.target.value)}
                                                    rows="4"
                                                    className="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm"
                                                />
                                            </div>
                                        ))}

                                        <div className="flex gap-4">
                                            <button onClick={salvarTemplates} disabled={savingTemplates} className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                                                {savingTemplates ? '💾 Salvando...' : '💾 Salvar'}
                                            </button>
                                            <button onClick={carregarTemplates} disabled={loadingTemplates} className="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 disabled:opacity-50">
                                                🔄 Recarregar
                                            </button>
                                        </div>

                                        <div className="bg-blue-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-blue-800 mb-2">📝 Variáveis Disponíveis</h3>
                                            <p className="text-sm text-gray-700">Use estas variáveis no texto (serão substituídas automaticamente):</p>
                                            <ul className="text-sm text-gray-600 mt-2 space-y-1">
                                                <li><code className="bg-white px-2 py-1 rounded">[NOME]</code> - Nome do cliente</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[CPF_CNPJ]</code> - CPF ou CNPJ</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[ENDERECO]</code> - Endereço completo</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[CIDADE]</code> - Cidade</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[ESTADO]</code> - Estado (UF)</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[DATA]</code> - Data atual</li>
                                                <li><code className="bg-white px-2 py-1 rounded">[DESCONTO]</code> - Percentual de desconto</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <>
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
                                    <h2 className="text-3xl font-bold mb-2">Bem-vindo ao Painel Administrativo! 👋</h2>
                                    <p className="text-blue-100">Gerencie as propostas de energia de forma simples e eficiente</p>
                                    <div className="mt-4 flex gap-4">
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Total de Propostas</p>
                                            <p className="text-2xl font-bold">{propostas.length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Pendentes</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'pendente').length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Aprovadas</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'aprovado').length}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="mb-6 flex flex-col md:flex-row gap-4">
                                        <input type="text" placeholder="🔍 Buscar..." value={busca} onChange={(e) => setBusca(e.target.value)} className="flex-1 p-3 border border-gray-300 rounded-lg" />
                                        <select value={filtro} onChange={(e) => setFiltro(e.target.value)} className="p-3 border border-gray-300 rounded-lg">
                                            <option value="todos">Todos</option>
                                            <option value="pendente">Pendente</option>
                                            <option value="aprovado">Aprovado</option>
                                            <option value="reprovado">Reprovado</option>
                                            <option value="lista_espera">Lista de Espera</option>
                                        </select>
                                    </div>

                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50 border-b-2 border-gray-200">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cidade</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {propostasFiltradas.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="6" className="px-4 py-8 text-center text-gray-500">
                                                            {loading ? 'Carregando...' : 'Nenhuma proposta encontrada'}
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    propostasFiltradas.map((proposta) => (
                                                        <tr key={proposta.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                                {proposta.tipo_pessoa === 'fisica' 
                                                                    ? `${proposta.nome} ${proposta.sobrenome}`
                                                                    : proposta.nome_fantasia}
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.email}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{proposta.cidade}</td>
                                                            <td className="px-4 py-3 text-sm text-gray-600">{formatarData(proposta.created_at)}</td>
                                                            <td className="px-4 py-3">
                                                                <div className="relative">
                                                                    <button 
                                                                        onClick={() => toggleStatusMenu(proposta.id)} 
                                                                        disabled={proposta.updating}
                                                                        className="flex items-center gap-2 hover:opacity-80 disabled:opacity-50"
                                                                    >
                                                                        {getStatusBadge(proposta.status || 'pendente')}
                                                                        <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                                                        </svg>
                                                                    </button>
                                                                    
                                                                    {proposta.showMenu && (
                                                                        <div className="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-1">
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'pendente')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-yellow-50 text-yellow-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-yellow-500 rounded-full"></span>
                                                                                Pendente
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'aprovado')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-green-50 text-green-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                                                                Aprovado
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'reprovado')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-red-50 text-red-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                                                                                Reprovado
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => atualizarStatus(proposta.id, 'lista_espera')}
                                                                                className="w-full text-left px-4 py-2 text-sm hover:bg-orange-50 text-orange-800 flex items-center gap-2"
                                                                            >
                                                                                <span className="w-2 h-2 bg-orange-500 rounded-full"></span>
                                                                                Lista de Espera
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-3">
                                                                <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                                    📄 PDF
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AdminPanel />, document.getElementById('root'));
    </script>
</body>
</html>
