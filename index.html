<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>OBY Energy - Painel Administrativo</title>
ย ย <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>ย
ย ย <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
ย ย <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
ย ย <div id="root"></div>

ย ย <script type="text/babel">
ย ย ย ย const { useState, useEffect } = React;

ย ย ย ย // Configuraรงรตes do Supabase (MANTIDAS)
ย ย ย ย const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
ย ย ย ย const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

ย ย ย ย // Credenciais de Admin (MANTIDAS)
ย ย ย ย const ADMIN_USER = 'admin';
ย ย ย ย const ADMIN_PASS = 'oby2025';

ย ย ย ย // --- COMPONENTE: RELATรRIO FINANCEIRO (MANTIDO) ---
ย ย ย ย function FinancialReport({ propostas }) {
ย ย ย ย ย ยย
ย ย ย ย ย ย const propostasAprovadas = propostas.filter(p => p.status === 'aprovado' && p.simulacao_economia_mensal > 0);

ย ย ย ย ย ย const formatarMoeda = (valor) => {
ย ย ย ย ย ย ย ย const num = parseFloat(valor);ย
ย ย ย ย ย ย ย ย if (isNaN(num)) return 'R$ 0,00';
ย ย ย ย ย ย ย ย return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
ย ย ย ย ย ย };

ย ย ย ย ย ย const exportarParaCSV = () => {
ย ย ย ย ย ย ย ย const cabecalho = [
ย ย ย ย ย ย ย ย ย ย "Nยบ Contrato", "Vendedor", "Cliente", "Email", "Cidade",ย
ย ย ย ย ย ย ย ย ย ย "Consumo (kWh)", "Custo Atual (R$)", "Custo OBY (R$)",ย
ย ย ย ย ย ย ย ย ย ย "Desconto Aplicado (%)", "Economia Mensal (R$)", "Status"
ย ย ย ย ย ย ย ย ];

ย ย ย ย ย ย ย ย const linhas = propostasAprovadas.map(p => {
ย ย ย ย ย ย ย ย ย ย return [
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.numero_contrato || 'N/A'}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.vendedor || 'Sem Vendedor'}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.nome_completo || p.nome_fantasia || 'Sem nome'}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.email || ''}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.cidade || ''}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.consumo_kw || 0}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${formatarMoeda(p.simulacao_conta_atual).replace('R$', '').trim()}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${formatarMoeda(p.simulacao_conta_nova).replace('R$', '').trim()}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.desconto_aplicado || 0}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${formatarMoeda(p.simulacao_economia_mensal).replace('R$', '').trim()}"`,
ย ย ย ย ย ย ย ย ย ย ย ย `"${p.status}"`
ย ย ย ย ย ย ย ย ย ย ].join(';');
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย const csvContent = [cabecalho.join(';'), ...linhas].join('\n');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
ย ย ย ย ย ย ย ย const link = document.createElement("a");
ย ย ย ย ย ย ย ย const url = URL.createObjectURL(blob);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย link.setAttribute("href", url);
ย ย ย ย ย ย ย ย link.setAttribute("download", `relatorio_oby_financeiro_${new Date().toISOString().slice(0,10)}.csv`);
ย ย ย ย ย ย ย ย link.style.visibility = 'hidden';
ย ย ย ย ย ย ย ย document.body.appendChild(link);
ย ย ย ย ย ย ย ย link.click();
ย ย ย ย ย ย ย ย document.body.removeChild(link);

ย ย ย ย ย ย ย ย alert("Exportaรงรฃo iniciada! Verifique seus downloads.");
ย ย ย ย ย ย };

ย ย ย ย ย ย const totalEconomiaMensal = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_economia_mensal) || 0), 0);
ย ย ย ย ย ย const totalCustoAtual = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_atual) || 0), 0);
ย ย ย ย ย ย const totalCustoNovo = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_nova) || 0), 0);

ย ย ย ย ย ย return (
ย ย ย ย ย ย ย ย <div className="bg-white rounded-xl shadow-lg p-6">
ย ย ย ย ย ย ย ย ย ย <div className="flex justify-between items-center mb-6 border-b pb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h2 className="text-2xl font-bold text-gray-800">๐ Relatรณrio Financeiro de Propostas Aprovadas</h2>
ย ย ย ย ย ย ย ย ย ย ย ย <buttonย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย onClick={exportarParaCSV}ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:opacity-50"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย disabled={propostasAprovadas.length === 0}
ย ย ย ย ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย ย ย ย ย ย ย โฌ๏ธ Exportar para CSV
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
ย ย ย ย ย ย ย ย ย ย ย ย <div className="bg-blue-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-sm text-gray-600">Propostas Vรกlidas</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-2xl font-bold text-blue-800">{propostasAprovadas.length}</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div className="bg-green-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-sm text-gray-600">Total Economia Mensal</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-xl font-bold text-green-800">{formatarMoeda(totalEconomiaMensal)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div className="bg-yellow-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-sm text-gray-600">Soma Custo Atual</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-xl font-bold text-yellow-800">{formatarMoeda(totalCustoAtual)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div className="bg-red-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-sm text-gray-600">Soma Custo OBY</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p className="text-xl font-bold text-red-800">{formatarMoeda(totalCustoNovo)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div className="overflow-x-auto">
ย ย ย ย ย ย ย ย ย ย ย ย <table className="min-w-full divide-y divide-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <thead className="bg-gray-50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nยบ Contrato</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cidade</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">CPF</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tbody className="divide-y divide-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {propostasFiltradas.length === 0 ? (
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td colSpan="9" className="px-4 py-8 text-center text-gray-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {loading ? 'Carregando...' : 'Nenhuma proposta encontrada'}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ) : (
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย propostasFiltradas.map((proposta) => (
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr key={proposta.id} className="hover:bg-gray-50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm font-medium text-gray-900">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {proposta.nome_completo || proposta.nome_fantasia || 'Sem nome'}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm font-semibold text-blue-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {proposta.numero_contrato || '-'}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm text-gray-600">{proposta.email}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm text-gray-600">{proposta.cidade}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm text-gray-600">{proposta.telefone}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm text-gray-600">{proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 text-sm text-gray-600">{formatarData(proposta.created_at)}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {/* Simplificado: Apenas o Badge do Status (Botรฃo de status movido para o Modal) */}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {getStatusBadge(proposta.status || 'pendente')}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ Editar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ PDF
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ))
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย )}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td className="px-4 py-3 flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ Editar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onClick={() => gerarContratoPDF(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ PDF
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ))
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย )}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </>) : (
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <FinancialReport propostas={propostas} />
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย )
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </>
ย ย ย ย ย ย ย ย ย ย ย ย )}
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย {selectedProposta && (
ย ย ย ย ย ย ย ย ย ย ย ย <EditPropostaModalย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย proposta={selectedProposta}ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย onClose={() => setSelectedProposta(null)}ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย onSave={handleSaveEdit}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย saving={savingProposta}
ย ย ย ย ย ย ย ย ย ย ย ย />
ย ย ย ย ย ย ย ย ย ย )}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย );
ย ย ย ย }

ย ย ย ย ReactDOM.render(<AdminPanel />, document.getElementById('root'));
ย ย </script>
</body>
</html>
